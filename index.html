<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>評分系統（五構面版）</title>
  <style>
    :root{ 
      --bg: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #e0f2fe 100%);
      --card: #fff;
      --muted: #6b7280;
      --primary: #1e3a8a;
      --border: #e5e7eb;
      --accent: #eceff1;
      --accent-border: #b0bec5;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif;
      background: var(--bg);
      background-attachment: fixed;
      color:#111827;
      min-height: 100vh;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(30, 58, 138, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
    .banner-hero { width: 100%; text-align: center; margin: 20px 0 40px 0; position: relative; z-index: 1; }
    .banner-hero img { max-width: min(1024px, 90%); height: auto; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.1); }
    .wrap{
      max-width:1024px; margin: 0 auto 42px auto; padding:24px;
      background: rgba(255,255,255,0.95);
      border:1px solid rgba(255,255,255,0.2); border-radius:16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
    }
    h1{margin:0 0 8px 0;font-size:24px;color:var(--primary);}
    .sub{color:var(--muted);font-size:14px;margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    label{font-weight:600}
    select,input,textarea,button{font-size:16px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    select,input{min-width:120px}
    input[type=number]{width:110px}
    button{cursor:pointer}
    button.primary{background:var(--primary);color:#fff}
    .hint{color:#b91c1c;font-weight:700}
    .scoreBox{
      margin-left:auto;background: var(--accent);padding:10px 14px;border-radius:10px;border:1px solid var(--accent-border);box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .scoreBox b{font-size:18px;color:var(--primary);}
    .block{border:1px solid var(--border);border-radius:14px;margin:18px 0;overflow:hidden}
    .block>header{display:flex;justify-content:space-between;align-items:center;background: var(--accent);padding:10px 14px;border-bottom:1px solid var(--accent-border);}
    .block>header h3{margin:0;font-size:16px;color:var(--primary);}
    .grid{display:grid;grid-template-columns: 1fr 140px;gap:12px;padding:14px}
    .grid label{align-self:center}
    textarea{width:100%;min-height:100px}
    .muted{color:var(--muted)}
    .msg{margin-left:8px}
    .pill{padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;font-size:12px}
    .badge{ padding:2px 8px;border-radius:6px;border:1px solid var(--accent-border);background: var(--accent);color: var(--primary);font-size:12px;font-weight: 600; }
    .footer{margin-top:8px;color:var(--muted);font-size:12px}
    .divider{height:1px;background:var(--border);margin:16px 0}
    .link{color:#2563eb;text-decoration:none}
    .link:hover{text-decoration:underline}
    table th, table td{padding:6px 4px}
    @media (max-width: 1024px) {
      .banner-hero { margin: 10px 0 30px 0; }
      .banner-hero img { max-width: 95%; border-radius: 12px; }
      .wrap { margin: 0 20px 30px 20px; padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="banner-hero">
    <img src="https://startup.sme.gov.tw/home/upload/event/20250715040629wvp.jpg" alt="2025創櫃菁英選拔會" />
  </div>

  <div class="wrap">
    <h1 id="title">評分系統（五構面版）</h1>
    <div class="sub"><span class="hint">每構面請依滿分區間打分（I/M ≤30；T ≤20；F/E ≤10），總分將即時相加。</span></div>

    <div class="row">
      <label for="project">受評公司</label>
      <select id="project"></select>
      <button id="btnLast">查看評分</button>
      <button id="btnList">查看所有公司評分</button>
      <button id="btnFinal"><span class="hint">20家成績最終確認</span></button>
      <div class="scoreBox">目前總分：<b id="liveTotal">0.00</b> / 100</div>
    </div>

    <section class="block" id="secI">
      <header><h3>一、產品創新與行銷 <span class="badge">滿分 30</span></h3></header>
      <div class="grid">
        <label for="I">產品創新與行銷整體評分</label>
        <input type="number" id="I" min="0" max="30" value="0">
      </div>
    </section>

    <section class="block" id="secM">
      <header><h3>二、市場需求與規模 <span class="badge">滿分 30</span></h3></header>
      <div class="grid">
        <label for="M">市場需求與規模整體評分</label>
        <input type="number" id="M" min="0" max="30" value="0">
      </div>
    </section>

    <section class="block" id="secT">
      <header><h3>三、技術門檻 <span class="badge">滿分 20</span></h3></header>
      <div class="grid">
        <label for="T">技術門檻整體評分</label>
        <input type="number" id="T" min="0" max="20" value="0">
      </div>
    </section>

    <section class="block" id="secF">
      <header><h3>四、財務狀況 <span class="badge">滿分 10</span></h3></header>
      <div class="grid">
        <label for="F">財務狀況整體評分</label>
        <input type="number" id="F" min="0" max="10" value="0">
      </div>
    </section>

    <section class="block" id="secE">
      <header><h3>五、經營團隊 <span class="badge">滿分 10</span></h3></header>
      <div class="grid">
        <label for="E">經營團隊整體評分</label>
        <input type="number" id="E" min="0" max="10" value="0">
      </div>
    </section>

    <div class="row">
      <label for="comment">委員意見</label>
      <textarea id="comment" maxlength="300" placeholder="（可留空，最多 300 字）"></textarea>
    </div>

    <div class="row">
      <button class="primary" id="btnSave">送出評分</button>
      <span class="msg muted" id="msg"></span>
    </div>

    <section class="block" id="myList" style="display:none">
      <header>
        <h3>我的評分總覽</h3>
        <span class="muted">點「檢視」可切換並載入該隊上一筆評分</span>
      </header>
      <div id="myListBody" style="padding:14px"></div>
    </section>

    <div class="divider"></div>
    <div class="footer">前端：GitHub Pages．後端：Google Apps Script．</div>

    <!-- Final Modal -->
    <div id="finalModal" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:9999;">
      <div style="width:min(960px,90vw);max-height:80vh;overflow:auto;background:#fff;border-radius:14px;border:1px solid #e5e7eb;box-shadow:0 20px 40px rgba(0,0,0,.2);">
        <header style="padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:16px">最終確認 — 我打的所有分數</h3>
          <button id="finalClose" class="ghost" style="padding:6px 10px">關閉</button>
        </header>
        <div style="padding:14px 16px">
          <div id="finalHint" class="muted" style="margin-bottom:8px"></div>
          <div id="finalTableWrap" style="overflow:auto;border:1px solid #e5e7eb;border-radius:10px">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px">報名編號</th>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px">隊伍名稱</th>
                  <th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:8px">總分</th>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px">最後更新</th>
                </tr>
              </thead>
              <tbody id="finalTbody"></tbody>
            </table>
          </div>
          <div style="margin-top:12px">
            <label style="display:flex;gap:8px;align-items:flex-start">
              <input type="checkbox" id="finalCheck">
              <span>我已核對上表內容，<b>確認這是我最終要送出的分數</b><span class="hint">(注意：送出後無法修改)。</span></span>
            </label>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
            <button id="finalSubmit" class="primary">送出20家成績最終確認</button>
          </div>
          <div id="finalMsg" class="muted" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***** 請把下列 URL 改成你真正的 GAS 部署網址（Web app 的「最新部署」URL） *****/
    // 例：const API_URL = 'https://script.google.com/macros/s/XXXXXXXX/exec';
    const API_URL = 'https://script.google.com/macros/s/AKfycbxYonZdwpJqFYEpwNqci1zpiAk6T7JgtyLeqP3ICRr-w-RukYAKzp_1L1Ngu42x8vhb/exec';
    const $ = q => document.querySelector(q);
    const params = new URLSearchParams(location.search);
    const JUDGE = decodeURIComponent(params.get('judge')||'').trim();

    // 構面代碼
    const IDS = ['I', 'M', 'T', 'F', 'E'];
    const MAX = { I:30, M:30, T:20, F:10, E:10 };

    const els = IDS.map(id=>document.getElementById(id));

    function toast(msg, ok=true){
      const m=$('#msg'); m.textContent=msg; m.style.color= ok?'#059669':'#b91c1c';
    }

    // 即時總分（直接相加）
    function liveTotal(){
      let t=0;
      els.forEach(el=>{
        const v=Number(el.value||0);
        if(!isNaN(v)) t += v;
      });
      $('#liveTotal').textContent=t.toFixed(2);
      return t;
    }

    function buildProjectOptionText(p){ return `${p.id}｜${p.team}${p.hasScore?'（已評分）':''}`; }

    // JSONP 呼叫（相容 GitHub Pages 跨網域）
    function jsonp(paramsObj){
      return new Promise((resolve,reject)=>{
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        window[cb] = (data)=>{ resolve(data); cleanup(); };
        const s = document.createElement('script');
        const qs = new URLSearchParams(paramsObj);
        qs.set('callback', cb);
        s.src = API_URL + (API_URL.includes('?')?'&':'?') + qs.toString();
        s.onerror = ()=>{ reject(new Error('連線失敗（JSONP）')); cleanup(); };
        document.head.appendChild(s);
        function cleanup(){ try{delete window[cb]}catch{}; try{s.remove()}catch{}; }
      });
    }

    async function apiGET(qs){ return jsonp(Object.fromEntries(new URLSearchParams(qs))); }
    async function apiPOST(body){ return jsonp(body); } // 後端也支援用 doGet JSONP 帶 action=save/confirm

    async function loadInit(){
      const d = await apiGET(`action=init&judge=${encodeURIComponent(JUDGE)}`);
      $('#title').textContent = JUDGE? `${JUDGE} 評選委員` : '評分系統（未帶入評審姓名）';
      const sel = $('#project'); sel.innerHTML='';
      if(!d.projects?.length){ sel.innerHTML = '<option value="">（尚無隊伍）</option>'; return; }
      d.projects.forEach(p=>{
        const opt=document.createElement('option');
        opt.value=JSON.stringify(p);
        opt.textContent=buildProjectOptionText(p);
        sel.appendChild(opt);
      });
    }

    function fillScores(map){
      if(!map) return;
      for(const id of IDS){
        const el = document.getElementById(id);
        const v = map[id] ?? 0;
        el.value = v;
      }
      liveTotal();
    }

    async function loadLast(){
      const p = getSelectedProject();
      if(!p) return toast('請先選擇團隊', false);
      const data = await apiGET(`action=last&judge=${encodeURIComponent(JUDGE)}&projectId=${encodeURIComponent(p.id)}`);
      if(!data || !data.items){ toast('沒有上一筆評分'); resetScores(); return; }
      fillScores(data.items);
      $('#comment').value = data.comment || '';
      toast('已載入前一次評分');
    }

    function resetScores(){ els.forEach(el=>el.value=0); $('#comment').value=''; liveTotal(); }
    function getSelectedProject(){ const v=$('#project').value; if(!v) return null; return JSON.parse(v); }

    async function save(){
      const p = getSelectedProject();
      const btn=$('#btnSave');
      if(!JUDGE){ toast('URL 未帶入 judge=評審姓名', false); return; }
      if(!p) return toast('請先選擇團隊', false);

      // 前端區間驗證（配合後端 I/M ≤30；T ≤20；F/E ≤10）
      const scores={};
      for(const id of IDS){
        const el = document.getElementById(id);
        const n = Number(el.value||0);
        const hi = MAX[id];
        if(Number.isNaN(n) || n<0 || n>hi){
          el.focus();
          throw new Error(`${id} 構面分數需介於 0~${hi}`);
        }
        scores[id]=n;
      }

      const body = {
        action:'save',
        data: JSON.stringify({
          judge:JUDGE,
          projectId:p.id,
          team:p.team,
          vendor:p.vendor||'',
          scores,
          comment:$('#comment').value.trim()
        })
      };

      btn.disabled=true; btn.textContent='送出中…';
      try{
        const res = await apiPOST(body);
        if (!res || res.ok === false) throw new Error(res?.error || '後端回傳失敗');

        const total = Number(res.total);
        if (!Number.isFinite(total)) throw new Error('後端未回傳總分（total）。');

        toast(`已送出，總分 ${total.toFixed(2)}`);
        p.hasScore = true;

        // 修正：更新目前選項的顯示文字
        const sel = $('#project');
        const opt = sel.options[sel.selectedIndex];
        if (opt) opt.textContent = buildProjectOptionText(p);

      }catch(e){
        toast(e.message || '送出失敗', false);
      }finally{
        btn.disabled=false; btn.textContent='送出評分';
      }
    }

    function renderMyList(items){
      const box = document.getElementById('myList');
      const body = document.getElementById('myListBody');
      if(!items || !items.length){
        body.innerHTML = '<div class="muted">尚無評分紀錄</div>';
        box.style.display = '';
        return;
      }
      const rows = items.map(it=>{
        const time = it.updatedAt ? new Date(it.updatedAt) : null;
        const timeStr = time ? time.toLocaleString('zh-TW') : '';
        const totalStr = (it.total!==undefined && it.total!==null) ? Number(it.total).toFixed(2) : '';
        return `
          <tr>
            <td>${it.projectId}</td>
            <td>${it.team||''}</td>
            <td style="text-align:right">${totalStr}</td>
            <td>${timeStr}</td>
            <td><button class="ghost" data-pid="${it.projectId}">檢視</button></td>
          </tr>`;
      }).join('');
      body.innerHTML = `
        <div style="overflow:auto">
          <table style="width:100%; border-collapse:collapse">
            <thead>
              <tr>
                <th style="text-align:left; border-bottom:1px solid var(--border); padding:6px 4px">報名編號</th>
                <th style="text-align:left; border-bottom:1px solid var(--border); padding:6px 4px">隊伍名稱</th>
                <th style="text-align:right;border-bottom:1px solid var(--border); padding:6px 4px">總分</th>
                <th style="text-align:left; border-bottom:1px solid var(--border); padding:6px 4px">最後更新</th>
                <th style="text-align:left; border-bottom:1px solid var(--border); padding:6px 4px">操作</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
      box.style.display = '';
      body.querySelectorAll('button[data-pid]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-pid');
          const sel = document.getElementById('project');
          let found = null;
          [...sel.options].forEach(opt=>{
            if(!opt.value) return;
            const p = JSON.parse(opt.value);
            if (String(p.id) === String(pid)) found = opt;
          });
          if(found){
            sel.value = found.value;
            resetScores();
            loadLast().catch(()=>{});
            toast(`已切換至 ${pid}，並載入上一筆評分`);
            window.scrollTo({ top:0, behavior:'smooth' });
          }else{
            toast(`名單中找不到編號 ${pid}（可能未在「比賽隊伍列表」）`, false);
          }
        });
      });
    }

    async function loadMyScores(){
      const res = await apiGET(`action=list&judge=${encodeURIComponent(JUDGE)}`);
      renderMyList(res.items || []);
    }

    async function fetchAllProjectsCount(){
      const d = await apiGET(`action=init&judge=${encodeURIComponent(JUDGE)}`);
      return (d.projects || []).length;
    }

    async function openFinalModal(){
      const modal = document.getElementById('finalModal');
      const tbody = document.getElementById('finalTbody');
      const hint  = document.getElementById('finalHint');
      const msg   = document.getElementById('finalMsg');
      const chk   = document.getElementById('finalCheck');
      msg.textContent = '';
      chk.checked = false;
      tbody.innerHTML = '<tr><td colspan="4" style="padding:12px">讀取中…</td></tr>';
      modal.style.display = 'flex';
      const [listRes, totalCount] = await Promise.all([
        apiGET(`action=list&judge=${encodeURIComponent(JUDGE)}`),
        fetchAllProjectsCount()
      ]);
      const items = listRes.items || [];
      if (!items.length){
        tbody.innerHTML = '<tr><td colspan="4" style="padding:12px">尚無評分紀錄</td></tr>';
      }else{
        tbody.innerHTML = items.map(it=>{
          const time = it.updatedAt ? new Date(it.updatedAt) : null;
          const timeStr = time ? time.toLocaleString('zh-TW') : '';
          const totalStr = (it.total!==undefined && it.total!==null) ? Number(it.total).toFixed(2) : '';
          return `<tr>
            <td style="padding:8px;border-bottom:1px solid #e5e7eb">${it.projectId}</td>
            <td style="padding:8px;border-bottom:1px solid #e5e7eb">${it.team||''}</td>
            <td style="padding:8px;border-bottom:1px solid #e5e7eb;text-align:right">${totalStr}</td>
            <td style="padding:8px;border-bottom:1px solid #e5e7eb">${timeStr}</td>
          </tr>`;
        }).join('');
      }
      hint.innerHTML = `已評隊伍數：<b>${items.length}</b>／全部隊伍數：<b>${totalCount}</b>。${items.length<totalCount ? '（尚未評完，不能送出20家成績最終確認）' : ''}`;
      document.getElementById('finalSubmit').disabled = (items.length < totalCount);
    }

    async function submitFinalConfirm(){
      const chk = document.getElementById('finalCheck');
      const msg = document.getElementById('finalMsg');
      if(!chk.checked){
        msg.textContent = '請先勾選確認聲明。';
        msg.style.color = '#b91c1c';
        return;
      }
      msg.textContent = '送出中…';
      msg.style.color = '#6b7280';
      try{
        const res = await apiPOST({ action:'confirm', data: JSON.stringify({ judge: JUDGE }) });
        if (!res || res.ok === false) throw new Error(res?.error || '後端回傳失敗');
        msg.textContent = '已完成最終確認！';
        msg.style.color = '#059669';
      }catch(e){
        msg.textContent = e.message || '送出失敗';
        msg.style.color = '#b91c1c';
      }
    }

    // 綁定事件
    els.forEach(el=>{
      // 限制輸入不超過各構面上限（UX 保護）
      el.addEventListener('input', ()=>{
        const max = MAX[el.id];
        let v = Number(el.value||0);
        if (v < 0) v = 0;
        if (v > max) v = max;
        el.value = v;
        liveTotal();
      });
    });

    $('#btnSave').addEventListener('click', ()=>{ save().catch(e=>toast(e.message||'送出失敗', false)); });
    $('#btnLast').addEventListener('click', ()=>{ loadLast().catch(e=>toast(e.message||'讀取失敗', false)); });
    document.getElementById('btnList').addEventListener('click', ()=>{ loadMyScores().catch(()=>toast('讀取失敗', false)); });
    document.getElementById('project').addEventListener('change', ()=>{ resetScores(); toast('已切換團隊，請輸入新分數'); });
    document.getElementById('btnFinal').addEventListener('click', ()=>{ openFinalModal().catch(()=>toast('讀取失敗',false)); });
    document.getElementById('finalClose').addEventListener('click', ()=>{ document.getElementById('finalModal').style.display='none'; });
    document.getElementById('finalSubmit').addEventListener('click', ()=>{ submitFinalConfirm().catch(()=>{}); });

    // 初始化
    liveTotal();
    loadInit().catch(e=> toast(e.message||'初始化失敗', false));
  </script>
</body>
</html>
