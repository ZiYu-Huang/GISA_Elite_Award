<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>評分系統（五構面版）</title>
  <style>
    :root{ --bg:#f6f7fb;--card:#fff;--muted:#6b7280;--primary:#1f2937;--border:#e5e7eb;--accent:#fff59d; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif;background:var(--bg);color:#111827}
    .wrap{max-width:1024px;margin:42px auto;padding:24px;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.06)}
    h1{margin:0 0 8px 0;font-size:24px}
    .sub{color:var(--muted);font-size:14px;margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    label{font-weight:600}
    select,input,textarea,button{font-size:16px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    select,input{min-width:120px}
    input[type=number]{width:110px}
    button{cursor:pointer}
    button.primary{background:#111827;color:#fff}
    .ghost{background:#fff}
    .hint{color:#b91c1c;font-weight:700}
    .scoreBox{margin-left:auto;background:var(--accent);padding:10px 14px;border-radius:10px;border:1px solid #facc15}
    .scoreBox b{font-size:18px}
    .block{border:1px solid var(--border);border-radius:14px;margin:18px 0;overflow:hidden}
    .block>header{display:flex;justify-content:space-between;align-items:center;background:var(--accent);padding:10px 14px;border-bottom:1px solid #facc15}
    .block>header h3{margin:0;font-size:16px}
    .grid{display:grid;grid-template-columns: 1fr 140px 1fr 140px;gap:12px;padding:14px}
    .grid label{align-self:center}
    textarea{width:100%;min-height:100px}
    .muted{color:var(--muted)}
    .msg{margin-left:8px}
    .pill{padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;font-size:12px}
    .badge{padding:2px 8px;border-radius:6px;border:1px solid #fde68a;background:#fffbeb;color:#92400e;font-size:12px}
    .footer{margin-top:8px;color:#6b7280;font-size:12px}
    .divider{height:1px;background:var(--border);margin:16px 0}
    .link{color:#2563eb;text-decoration:none}
    .link:hover{text-decoration:underline}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 4px;border-bottom:1px solid var(--border);font-size:14px}
    th{text-align:left;background:#f9fafb}
    td button{font-size:14px;padding:4px 8px}

    /* === 總覽 Modal === */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:9999;
    }
    .modal{
      width:min(920px, 96vw); background:#fff; border-radius:16px; border:1px solid var(--border);
      box-shadow:0 24px 60px rgba(0,0,0,.2); overflow:hidden;
    }
    .modal header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#fffbeb;border-bottom:1px solid #fde68a}
    .modal .body{padding:16px; max-height:70vh; overflow:auto}
    .modal footer{display:flex;gap:12px;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid var(--border); background:#fafafa}
    .modal .title{margin:0;font-size:18px}
    .modal .close{border:none;background:transparent;font-size:18px;cursor:pointer}
    .danger{background:#111827;color:#fff}
    .ghost{background:#fff}
    .muted-small{font-size:12px;color:#6b7280}
    .error{color:#b91c1c;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="title">評分系統（五構面版）</h1>
    <div class="sub">輸入 0–100 分，系統會依權重即時計算總分。</div>

    <div class="row">
      <label for="project">評分團隊</label>
      <select id="project"></select>
      <button id="btnLast">取得前一次評分紀錄</button>
      <button id="btnList">查看我的評分</button>
      <button id="btnReview" class="ghost">送出前總覽</button>
      <span class="hint">（請輸入 0～100，滿分 100）</span>
      <div class="scoreBox">得分計算：<b id="liveTotal">0.00</b></div>
    </div>

    <!-- 1) 產品創新與行銷 30% -->
    <section class="block" id="secI">
      <header>
        <h3>一、產品創新與行銷 <span class="badge">30%</span></h3>
        <span class="muted">各7.5%</span>
      </header>
      <div class="grid">
        <label for="I1">面對市場的問題是真正的痛點嗎</label><input type="number" id="I1" min="0" max="100" value="0">
        <label for="I2">產品解決痛點的效果如何</label><input type="number" id="I2" min="0" max="100" value="0">
        <label for="I3">市場行銷策略可行性</label><input type="number" id="I3" min="0" max="100" value="0">
        <label for="I4">業務是否可擴展</label><input type="number" id="I4" min="0" max="100" value="0">
      </div>
    </section>

    <!-- 2) 市場需求與規模 30% -->
    <section class="block" id="secM">
      <header>
        <h3>二、市場需求與規模 <span class="badge">30%</span></h3>
        <span class="muted">各7.5%</span>
      </header>
      <div class="grid">
        <label for="M1">市場規模合理性與成長性</label><input type="number" id="M1" min="0" max="100" value="0">
        <label for="M2">目標市場對象是否合宜</label><input type="number" id="M2" min="0" max="100" value="0">
        <label for="M3">企業收入/客戶穩定性與持續性</label><input type="number" id="M3" min="0" max="100" value="0">
        <label for="M4">企業發展速度有多快</label><input type="number" id="M4" min="0" max="100" value="0">
      </div>
    </section>

    <!-- 3) 技術門檻 20% -->
    <section class="block" id="secT">
      <header>
        <h3>三、技術門檻 <span class="badge">20%</span></h3>
        <span class="muted">各10%</span>
      </header>
      <div class="grid">
        <label for="T1">企業與競爭對手相比有哪些優勢</label><input type="number" id="T1" min="0" max="100" value="0">
        <label for="T2">進入門檻有多高</label><input type="number" id="T2" min="0" max="100" value="0">
      </div>
    </section>

    <!-- 4) 財務狀況 10% -->
    <section class="block" id="secF">
      <header>
        <h3>四、財務狀況 <span class="badge">10%</span></h3>
        <span class="muted">各約3.3%</span>
      </header>
      <div class="grid">
        <label for="F1">企業過去財務績效</label><input type="number" id="F1" min="0" max="100" value="0">
        <label for="F2">企業未來財務規劃</label><input type="number" id="F2" min="0" max="100" value="0">
        <label for="F3">企業是否有強大的創收計畫</label><input type="number" id="F3" min="0" max="100" value="0">
      </div>
    </section>

    <!-- 5) 經營團隊 10% -->
    <section class="block" id="secE">
      <header>
        <h3>五、經營團隊 <span class="badge">10%</span></h3>
        <span class="muted">各5%</span>
      </header>
      <div class="grid">
        <label for="E1">團隊實力</label><input type="number" id="E1" min="0" max="100" value="0">
        <label for="E2">團隊成員是否具備合適的背景或工作經驗</label><input type="number" id="E2" min="0" max="100" value="0">
      </div>
    </section>

    <div class="row">
      <label for="comment">委員意見</label>
      <textarea id="comment" maxlength="300" placeholder="（可留空，最多 300 字）"></textarea>
    </div>

    <div class="row">
      <button class="primary" id="btnSave">送出評分</button>
      <span class="msg muted" id="msg"></span>
    </div>

    <!-- 我的評分總覽（列表） -->
    <section class="block" id="myList" style="display:none">
      <header>
        <h3>我的評分總覽</h3>
        <span class="muted">點「檢視」可直接切換並載入該隊上次評分</span>
      </header>
      <div id="myListBody" style="padding:14px"></div>
    </section>

    <div class="divider"></div>
    <div class="footer">前端：GitHub Pages．後端：Google Apps Script．</div>
  </div>

  <!-- === Modal：送出前總覽 === -->
  <div id="reviewBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="reviewTitle">
    <div class="modal">
      <header>
        <h3 class="title" id="reviewTitle">送出前總覽</h3>
        <button class="close" id="reviewClose" aria-label="關閉">✕</button>
      </header>
      <div class="body">
        <div id="reviewMeta" class="muted" style="margin-bottom:8px"></div>
        <div id="reviewMissing" class="error" style="display:none;margin-bottom:8px"></div>
        <div id="reviewTable"></div>
        <div style="margin-top:12px">
          <label><input type="checkbox" id="confirmChk"> 我確認這是我要送出的分數</label>
        </div>
      </div>
      <footer>
        <span class="muted-small">確認後仍可回到上方頁面修改再送出。</span>
        <div style="display:flex;gap:8px">
          <button class="ghost" id="btnCancelReview">取消</button>
          <button class="danger" id="btnFinalSubmit" disabled>確認送出並關閉</button>
        </div>
      </footer>
    </div>
  </div>

  <script>
    /* 你的 GAS Web App URL（/exec） */
    const API_URL = 'https://script.google.com/macros/s/AKfycbwuebWFtlKRMAhNeMSqPTwHVBizLWJ__hQXiUn4lJxp6ETHO3SdbBJhZ7UKKMVitaXJ/exec';

    /* 權重 */
    const W = { I1:.075,I2:.075,I3:.075,I4:.075, M1:.075,M2:.075,M3:.075,M4:.075, T1:.10,T2:.10, F1:.033,F2:.033,F3:.034, E1:.05,E2:.05 };

    const $ = q => document.querySelector(q);
    const JUDGE = decodeURIComponent(new URLSearchParams(location.search).get('judge')||'').trim();

    const IDS = ['I1','I2','I3','I4','M1','M2','M3','M4','T1','T2','F1','F2','F3','E1','E2'];
    const els = IDS.map(id=>document.getElementById(id));

    function toast(msg, ok=true){ const m=$('#msg'); m.textContent=msg; m.style.color= ok?'#059669':'#b91c1c'; }
    function liveTotal(){ let t=0; els.forEach(el=>{const v=Number(el.value||0); if(!isNaN(v)) t += v * (W[el.id]||0);}); $('#liveTotal').textContent=t.toFixed(2); return t; }
    function buildProjectOptionText(p){ return `${p.id}｜${p.team}${p.hasScore?'（已評分）':''}`; }

    // --- JSONP helper（繞過 CORS） ---
    function jsonp(params){
      return new Promise((resolve,reject)=>{
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        window[cb] = (data)=>{ resolve(data); cleanup(); };
        const s = document.createElement('script');
        const qs = new URLSearchParams(params);
        qs.set('callback', cb);
        s.src = API_URL + (API_URL.includes('?')?'&':'?') + qs.toString();
        s.onerror = ()=>{ reject(new Error('連線失敗（JSONP）')); cleanup(); };
        document.head.appendChild(s);
        function cleanup(){ delete window[cb]; s.remove(); }
      });
    }
    async function apiGET(q){ return jsonp(Object.fromEntries(new URLSearchParams(q))); }
    async function apiPOST(body){ return jsonp(body); }

    async function loadInit(){
      const d = await apiGET(`action=init&judge=${encodeURIComponent(JUDGE)}`);
      $('#title').textContent = JUDGE? `${JUDGE} 評分表` : '評分系統（未帶入評審姓名）';
      const sel = $('#project'); sel.innerHTML='';
      if(!d.projects?.length){ sel.innerHTML = '<option value="">（尚無隊伍）</option>'; return; }
      d.projects.forEach(p=>{ const opt=document.createElement('option'); opt.value=JSON.stringify(p); opt.textContent=buildProjectOptionText(p); sel.appendChild(opt); });
    }

    function fillScores(map){
      if(!map) return;
      for(const id of IDS){ document.getElementById(id).value = map[id] ?? 0; }
      liveTotal();
    }

    async function loadLast(){
      const p = getSelectedProject(); if(!p) return toast('請先選擇團隊', false);
      const data = await apiGET(`action=last&judge=${encodeURIComponent(JUDGE)}&projectId=${encodeURIComponent(p.id)}`);
      if(!data || !data.items){ toast('沒有上一筆評分'); resetScores(); return; }
      fillScores(data.items); $('#comment').value = data.comment || ''; toast('已載入前一次評分');
    }

    function resetScores(){ els.forEach(el=>el.value=0); $('#comment').value=''; liveTotal(); }
    function getSelectedProject(){ const v=$('#project').value; if(!v) return null; return JSON.parse(v); }

  async function save(){
    const p = getSelectedProject(); 
    const btn = $('#btnSave');
    if(!p) return toast('請先選擇團隊', false);

    // 蒐集分數並檢核
    const scores = {};
    els.forEach(el=>{
      const n = Number(el.value||0);
      if(isNaN(n) || n<0 || n>100) throw new Error('每項需為 0~100');
      scores[el.id] = n;
    });

    // 組 payload（保持你現在用 JSONP 的做法）
    const body = {
      action: 'save',
      data: JSON.stringify({
        judge: JUDGE,
        projectId: p.id,
        team: p.team,
        vendor: p.vendor || '',
        scores,
        comment: $('#comment').value.trim()
      })
    };

    btn.disabled = true; 
    btn.textContent = '送出中…';

    try{
      const res = await apiPOST(body);

      // 關鍵：嚴格檢查是否成功且有 total
      if (!res || res.ok === false) {
        throw new Error(res?.error || '後端回應失敗');
      }
      if (typeof res.total !== 'number' || isNaN(res.total)) {
        throw new Error('後端未回傳有效總分');
      }

      const totalText = res.total.toFixed(2);
      toast(`已送出，總分 ${totalText}`);

      // 標記此隊已評分，更新下拉顯示
      p.hasScore = true;
      $('#project').selectedOptions[0].textContent = buildProjectOptionText(p);

      // 如果「我的評分總覽」有打開，刷新列表
      if ($('#myList').style.display !== 'none') {
        loadMyScores().catch(()=>{});
      }

      // 若所有隊伍都已評，彈出總覽 Modal
      if (allProjectsScored()) {
        openReviewModal();
      }
    }catch(e){
      toast(e.message || '送出失敗', false);
      // 若要檢查實際回傳內容，可暫時開啟：
      // console.log('save() error detail:', e);
    }finally{
      btn.disabled = false; 
      btn.textContent = '送出評分';
    }
  }
    // 判斷是否所有隊伍都有 hasScore=true
    function allProjectsScored(){
      const sel = $('#project');
      const opts = [...sel.options].filter(o=>o.value);
      if(!opts.length) return false;
      return opts.every(o=>{ const p = JSON.parse(o.value); return !!p.hasScore; });
    }

    // === 我的評分總覽（列表區） ===
    function renderMyList(items){
      const box=$('#myList'), body=$('#myListBody');
      if(!items.length){ body.innerHTML='<div class="muted">尚無評分紀錄</div>'; box.style.display=''; return; }
      const rows=items.map(it=>{
        const ts=it.updatedAt?new Date(it.updatedAt).toLocaleString('zh-TW'):'';
        return `<tr>
          <td>${it.projectId}</td><td>${it.team||''}</td>
          <td style="text-align:right">${it.total||''}</td>
          <td>${ts}</td>
          <td><button data-pid="${it.projectId}">檢視</button></td></tr>`;
      }).join('');
      body.innerHTML=`<table><thead><tr><th>報名編號</th><th>隊伍名稱</th><th>總分</th><th>最後更新</th><th>操作</th></tr></thead><tbody>${rows}</tbody></table>`;
      box.style.display='';
      body.querySelectorAll('button[data-pid]').forEach(btn=>{
        btn.addEventListener('click',()=>{ const pid=btn.getAttribute('data-pid'); const sel=$('#project'); [...sel.options].forEach(opt=>{ if(!opt.value) return; const p=JSON.parse(opt.value); if(String(p.id)===String(pid)){ sel.value=opt.value; resetScores(); loadLast().catch(()=>{}); } }); });
      });
    }
    async function loadMyScores(){ const res=await apiGET(`action=list&judge=${encodeURIComponent(JUDGE)}`); renderMyList(res.items||[]); return res.items||[]; }

    // === 送出前總覽（Modal） ===
    function buildReviewTable(items){
      if(!items.length){
        return '<div class="muted">目前尚無評分資料。</div>';
      }
      const rows = items.map(it=>`
        <tr>
          <td>${it.projectId}</td>
          <td>${it.team||''}</td>
          <td style="text-align:right">${it.total??''}</td>
          <td>${it.updatedAt?new Date(it.updatedAt).toLocaleString('zh-TW'):''}</td>
        </tr>
      `).join('');
      return `
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>報名編號</th>
                <th>隊伍名稱</th>
                <th style="text-align:right">總分</th>
                <th>最後更新</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    async function openReviewModal(){
      // 取我的評分清單
      const items = await loadMyScores().catch(()=>[]);
      // 與所有名單比對，列出尚未評分者
      const sel = $('#project');
      const all = [...sel.options].filter(o=>o.value).map(o=>JSON.parse(o.value));
      const doneSet = new Set(items.map(x=>String(x.projectId)));
      const missing = all.filter(p=>!doneSet.has(String(p.id)));

      $('#reviewMeta').textContent = `評審：${JUDGE || '（未帶入姓名）'}　已評：${items.length}／總隊伍：${all.length}`;
      $('#reviewTable').innerHTML = buildReviewTable(items);

      if (missing.length){
        $('#reviewMissing').style.display = '';
        $('#reviewMissing').textContent = '尚未評分的隊伍：' + missing.map(m=>`${m.id}｜${m.team}`).join('、');
      }else{
        $('#reviewMissing').style.display = 'none';
        $('#reviewMissing').textContent = '';
      }

      // reset 勾選 & 送出鈕狀態
      $('#confirmChk').checked = false;
      $('#btnFinalSubmit').disabled = !!missing.length; // 有缺就禁用

      // 顯示 modal
      $('#reviewBackdrop').style.display = 'flex';
    }
    function closeReviewModal(){ $('#reviewBackdrop').style.display='none'; }

    // 事件
    els.forEach(el=> el.addEventListener('input', liveTotal));
    $('#btnSave').addEventListener('click', ()=>{ save().catch(e=>toast(e.message||'送出失敗', false)); });
    $('#btnLast').addEventListener('click', ()=>{ loadLast().catch(e=>toast(e.message||'讀取失敗', false)); });
    $('#btnList').addEventListener('click', ()=>{ loadMyScores().catch(()=>toast('讀取失敗', false)); });
    $('#btnReview').addEventListener('click', ()=>{ openReviewModal().catch(()=>toast('讀取失敗', false)); });
    $('#project').addEventListener('change', ()=>{ resetScores(); toast('已切換團隊，請輸入新分數'); });

    // Modal 事件
    $('#reviewClose').addEventListener('click', closeReviewModal);
    $('#btnCancelReview').addEventListener('click', closeReviewModal);
    $('#confirmChk').addEventListener('change', (e)=>{
      const hasError = $('#reviewMissing').style.display !== 'none';
      $('#btnFinalSubmit').disabled = !e.target.checked || hasError;
    });
    $('#btnFinalSubmit').addEventListener('click', ()=>{
      // 這裡的「送出」只是最後確認，實際資料一筆筆已在按「送出評分」時上傳
      closeReviewModal();
      toast('已確認送出。若需更改，仍可回到此頁面修改單隊分數後再送出。');
    });

    // 啟動
    liveTotal();
    loadInit().catch(e=> toast(e.message||'初始化失敗', false));
  </script>
</body>
</html>
