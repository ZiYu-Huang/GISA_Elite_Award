<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è©•åˆ†ç³»çµ±</title>
  <style>
    /* åŸæœ‰çš„è®Šæ•¸è¨­å®š */
    :root{ 
      --bg: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #e0f2fe 100%);
      --card:#fff;
      --muted:#6b7280;
      --primary:#1f2937;
      --border:#e5e7eb;
      --accent:#fff59d; 
    }
    
    /* åŸæœ‰çš„åŸºç¤æ¨£å¼ï¼Œå®Œå…¨ä¸å‹• */
    *{box-sizing:border-box}
    
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif;
      background: var(--bg);
      background-attachment: fixed;
      color:#111827;
      min-height: 100vh;
    }
    
    /* èƒŒæ™¯è£é£¾æ•ˆæœ */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(30, 58, 138, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
    
    /* ğŸ”¥ é—œéµä¿®æ”¹ï¼šBanner ç¨ç«‹æ–¼å®¹å™¨å¤– */
    .banner-hero {
      width: 100%;
      text-align: center;
      margin: 20px 0 40px 0;
      position: relative;
      z-index: 1;
    }
    
    .banner-hero img {
      max-width: min(1024px, 90%);
      height: auto;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      /* è®“åœ–ç‰‡èˆ‡èƒŒæ™¯èåˆ */
      border: 2px solid rgba(255,255,255,0.1);
    }
    
    /* ä¸»å®¹å™¨èª¿æ•´ï¼šæ¸›å°‘ä¸Šé‚Šè·å› ç‚ºbannerå·²ç§»å‡º */
    .wrap{
      max-width:1024px;
      margin: 0 auto 42px auto; /* ä¸Šé‚Šè·æ”¹ç‚º0 */
      padding:24px;
      background: rgba(255,255,255,0.95);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    /* åŸæœ‰çš„æ‰€æœ‰æ¨£å¼ï¼Œå®Œå…¨ä¸å‹• */
    h1{margin:0 0 8px 0;font-size:24px;color:var(--primary);}
    .sub{color:var(--muted);font-size:14px;margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    label{font-weight:600}
    select,input,textarea,button{font-size:16px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    select,input{min-width:120px}
    input[type=number]{width:110px}
    button{cursor:pointer}
    button.primary{background:var(--primary);color:#fff}
    .hint{color:#b91c1c;font-weight:700}
    .scoreBox{margin-left:auto;background:var(--accent);padding:10px 14px;border-radius:10px;border:1px solid #facc15}
    .scoreBox b{font-size:18px}
    .block{border:1px solid var(--border);border-radius:14px;margin:18px 0;overflow:hidden}
    .block>header{display:flex;justify-content:space-between;align-items:center;background:var(--accent);padding:10px 14px;border-bottom:1px solid #facc15}
    .block>header h3{margin:0;font-size:16px}
    .grid{display:grid;grid-template-columns: 1fr 140px 1fr 140px;gap:12px;padding:14px}
    .grid label{align-self:center}
    textarea{width:100%;min-height:100px}
    .muted{color:var(--muted)}
    .msg{margin-left:8px}
    .pill{padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;font-size:12px}
    .badge{padding:2px 8px;border-radius:6px;border:1px solid #fde68a;background:#fffbeb;color:#92400e;font-size:12px}
    .footer{margin-top:8px;color:var(--muted);font-size:12px}
    .divider{height:1px;background:var(--border);margin:16px 0}
    .link{color:#2563eb;text-decoration:none}
    .link:hover{text-decoration:underline}
    table th, table td{padding:6px 4px}
    
    /* iPad æ©«ç‰ˆå„ªåŒ– */
    @media (max-width: 1024px) {
      .banner-hero {
        margin: 10px 0 30px 0;
      }
      
      .banner-hero img {
        max-width: 95%;
        border-radius: 12px;
      }
      
      .wrap {
        margin: 0 20px 30px 20px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- ğŸ”¥ Banner ç§»åˆ°å®¹å™¨å¤–ï¼Œèˆ‡èƒŒæ™¯èåˆ -->
  <div class="banner-hero">
    <img src="https://startup.sme.gov.tw/home/upload/event/20250715040629wvp.jpg"
         alt="2025å‰µæ«ƒèè‹±é¸æ‹”æœƒ" />
  </div>

  <div class="wrap">
    <h1 id="title">è©•åˆ†ç³»çµ±</h1>
    <div class="sub"><span class="hint">æ¯å€‹æ¬„ä½å‡è¼¸å…¥ 0â€“100 åˆ†ï¼Œç³»çµ±æœƒä¾æ¬Šé‡å³æ™‚è¨ˆç®—ç¸½åˆ†ã€‚</span></div>
<div class="row">
      <label for="project">å—è©•å…¬å¸</label>
      <select id="project"></select>
      <button id="btnLast">æŸ¥çœ‹è©•åˆ†</button>
      <button id="btnList">æŸ¥çœ‹æ‰€æœ‰å…¬å¸è©•åˆ†</button>
      <button id="btnFinal"><span class="hint">20å®¶æˆç¸¾æœ€çµ‚ç¢ºèª</button></span>
<!--       <span class="hint">ï¼ˆè«‹è¼¸å…¥ 0ï½100ï¼Œæ»¿åˆ† 100ï¼‰</span> -->
      <div class="scoreBox">å¾—åˆ†è¨ˆç®—ï¼š<b id="liveTotal">0.00</b></div>
    </div>
<!-- 1) ç”¢å“å‰µæ–°èˆ‡è¡ŒéŠ· 30% -->
    <section class="block" id="secI">
      <header>
        <h3>ä¸€ã€ç”¢å“å‰µæ–°èˆ‡è¡ŒéŠ· <span class="badge">30%</span></h3>
        <span class="muted">å„7.5%</span>
      </header>
      <div class="grid">
        <label for="I1">é¢å°å¸‚å ´çš„å•é¡Œæ˜¯çœŸæ­£çš„ç—›é»å—</label><input type="number" id="I1" min="0" max="100" value="0">
        <label for="I2">ç”¢å“è§£æ±ºç—›é»çš„æ•ˆæœå¦‚ä½•</label><input type="number" id="I2" min="0" max="100" value="0">
        <label for="I3">å¸‚å ´è¡ŒéŠ·ç­–ç•¥å¯è¡Œæ€§</label><input type="number" id="I3" min="0" max="100" value="0">
        <label for="I4">æ¥­å‹™æ˜¯å¦å¯æ“´å±•</label><input type="number" id="I4" min="0" max="100" value="0">
      </div>
    </section>
<!-- 2) å¸‚å ´éœ€æ±‚èˆ‡è¦æ¨¡ 30% -->
    <section class="block" id="secM">
      <header>
        <h3>äºŒã€å¸‚å ´éœ€æ±‚èˆ‡è¦æ¨¡ <span class="badge">30%</span></h3>
        <span class="muted">å„7.5%</span>
      </header>
      <div class="grid">
        <label for="M1">å¸‚å ´è¦æ¨¡åˆç†æ€§èˆ‡æˆé•·æ€§</label><input type="number" id="M1" min="0" max="100" value="0">
        <label for="M2">ç›®æ¨™å¸‚å ´å°è±¡æ˜¯å¦åˆå®œ</label><input type="number" id="M2" min="0" max="100" value="0">
        <label for="M3">ä¼æ¥­æ”¶å…¥/å®¢æˆ¶ç©©å®šæ€§èˆ‡æŒçºŒæ€§</label><input type="number" id="M3" min="0" max="100" value="0">
        <label for="M4">ä¼æ¥­ç™¼å±•é€Ÿåº¦æœ‰å¤šå¿«</label><input type="number" id="M4" min="0" max="100" value="0">
      </div>
    </section>
<!-- 3) æŠ€è¡“é–€æª» 20% -->
    <section class="block" id="secT">
      <header>
        <h3>ä¸‰ã€æŠ€è¡“é–€æª» <span class="badge">20%</span></h3>
        <span class="muted">å„10%</span>
      </header>
      <div class="grid">
        <label for="T1">ä¼æ¥­èˆ‡ç«¶çˆ­å°æ‰‹ç›¸æ¯”æœ‰å“ªäº›å„ªå‹¢</label><input type="number" id="T1" min="0" max="100" value="0">
        <label for="T2">é€²å…¥é–€æª»æœ‰å¤šé«˜</label><input type="number" id="T2" min="0" max="100" value="0">
      </div>
    </section>
<!-- 4) è²¡å‹™ç‹€æ³ 10% -->
    <section class="block" id="secF">
      <header>
        <h3>å››ã€è²¡å‹™ç‹€æ³ <span class="badge">10%</span></h3>
        <span class="muted">å„ç´„3.3%</span>
      </header>
      <div class="grid">
        <label for="F1">ä¼æ¥­éå»è²¡å‹™ç¸¾æ•ˆ</label><input type="number" id="F1" min="0" max="100" value="0">
        <label for="F2">ä¼æ¥­æœªä¾†è²¡å‹™è¦åŠƒ</label><input type="number" id="F2" min="0" max="100" value="0">
        <label for="F3">ä¼æ¥­æ˜¯å¦æœ‰å¼·å¤§çš„å‰µæ”¶è¨ˆç•«</label><input type="number" id="F3" min="0" max="100" value="0">
      </div>
    </section>
<!-- 5) ç¶“ç‡Ÿåœ˜éšŠ 10% -->
    <section class="block" id="secE">
      <header>
        <h3>äº”ã€ç¶“ç‡Ÿåœ˜éšŠ <span class="badge">10%</span></h3>
        <span class="muted">å„5%</span>
      </header>
      <div class="grid">
        <label for="E1">åœ˜éšŠå¯¦åŠ›</label><input type="number" id="E1" min="0" max="100" value="0">
        <label for="E2">åœ˜éšŠæˆå“¡æ˜¯å¦å…·å‚™åˆé©çš„èƒŒæ™¯æˆ–å·¥ä½œç¶“é©—</label><input type="number" id="E2" min="0" max="100" value="0">
      </div>
    </section>
<div class="row">
      <label for="comment">å§”å“¡æ„è¦‹</label>
      <textarea id="comment" maxlength="300" placeholder="ï¼ˆå¯ç•™ç©ºï¼Œæœ€å¤š 300 å­—ï¼‰"></textarea>
    </div>
<div class="row">
      <button class="primary" id="btnSave">é€å‡ºè©•åˆ†</button>
      <span class="msg muted" id="msg"></span>
    </div>
<!-- æˆ‘çš„è©•åˆ†ç¸½è¦½ï¼ˆåˆ—è¡¨ï¼‰ -->
    <section class="block" id="myList" style="display:none">
      <header>
        <h3>æˆ‘çš„è©•åˆ†ç¸½è¦½</h3>
        <span class="muted">é»ã€Œæª¢è¦–ã€å¯åˆ‡æ›ä¸¦è¼‰å…¥è©²éšŠä¸Šä¸€ç­†è©•åˆ†</span>
      </header>
      <div id="myListBody" style="padding:14px"></div>
    </section>
<div class="divider"></div>
    <div class="footer">å‰ç«¯ï¼šGitHub Pagesï¼å¾Œç«¯ï¼šGoogle Apps Scriptï¼</div>
    <!-- ç¢ºèªå½ˆçª— -->
    <div id="finalModal" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:9999;">
      <div style="width:min(960px,90vw);max-height:80vh;overflow:auto;background:#fff;border-radius:14px;border:1px solid #e5e7eb;box-shadow:0 20px 40px rgba(0,0,0,.2);">
        <header style="padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:16px">æœ€çµ‚ç¢ºèª â€” æˆ‘æ‰“çš„æ‰€æœ‰åˆ†æ•¸</h3>
          <button id="finalClose" class="ghost" style="padding:6px 10px">é—œé–‰</button>
        </header>
        <div style="padding:14px 16px">
          <div id="finalHint" class="muted" style="margin-bottom:8px"></div>
          <div id="finalTableWrap" style="overflow:auto;border:1px solid #e5e7eb;border-radius:10px">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px">å ±åç·¨è™Ÿ</th>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px">éšŠä¼åç¨±</th>
                  <th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:8px">ç¸½åˆ†</th>
                  <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px">æœ€å¾Œæ›´æ–°</th>
                </tr>
              </thead>
              <tbody id="finalTbody"></tbody>
            </table>
          </div>
          <div style="margin-top:12px">
            <label style="display:flex;gap:8px;align-items:flex-start">
              <input type="checkbox" id="finalCheck">
              <span>æˆ‘å·²æ ¸å°ä¸Šè¡¨å…§å®¹ï¼Œ<b>ç¢ºèªé€™æ˜¯æˆ‘æœ€çµ‚è¦é€å‡ºçš„åˆ†æ•¸</b><span class="hint">(æ³¨æ„ï¼šé€å‡ºå¾Œç„¡æ³•ä¿®æ”¹)ã€‚</span></span>
            </label>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
            <button id="finalSubmit" class="primary">é€å‡º20å®¶æˆç¸¾æœ€çµ‚ç¢ºèª</button>
          </div>
          <div id="finalMsg" class="muted" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>
  
  
  <script>
    /* ä½ çš„ GAS Web App URLï¼ˆ/execï¼‰ */
    const API_URL = 'https://script.google.com/macros/s/AKfycbwuebWFtlKRMAhNeMSqPTwHVBizLWJ__hQXiUn4lJxp6ETHO3SdbBJhZ7UKKMVitaXJ/exec';
/* æ¬Šé‡ */
    const W = { I1:.075,I2:.075,I3:.075,I4:.075, M1:.075,M2:.075,M3:.075,M4:.075, T1:.10,T2:.10, F1:.033,F2:.033,F3:.034, E1:.05,E2:.05 };
const $ = q => document.querySelector(q);
    const params = new URLSearchParams(location.search);
    const JUDGE = decodeURIComponent(params.get('judge')||'').trim();
const IDS = ['I1','I2','I3','I4','M1','M2','M3','M4','T1','T2','F1','F2','F3','E1','E2'];
    const els = IDS.map(id=>document.getElementById(id));
function toast(msg, ok=true){ const m=$('#msg'); m.textContent=msg; m.style.color= ok?'#059669':'#b91c1c'; }
    function liveTotal(){ let t=0; els.forEach(el=>{const v=Number(el.value||0); if(!isNaN(v)) t += v * (W[el.id]||0);}); $('#liveTotal').textContent=t.toFixed(2); return t; }
    function buildProjectOptionText(p){ return `${p.id}ï½œ${p.team}${p.hasScore?'ï¼ˆå·²è©•åˆ†ï¼‰':''}`; }
// --- JSONP helperï¼ˆç¹é CORSï¼‰ ---
    function jsonp(params){
      return new Promise((resolve,reject)=>{
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        window[cb] = (data)=>{ resolve(data); cleanup(); };
        const s = document.createElement('script');
        const qs = new URLSearchParams(params);
        qs.set('callback', cb);
        s.src = API_URL + (API_URL.includes('?')?'&':'?') + qs.toString();
        s.onerror = ()=>{ reject(new Error('é€£ç·šå¤±æ•—ï¼ˆJSONPï¼‰')); cleanup(); };
        document.head.appendChild(s);
        function cleanup(){ delete window[cb]; s.remove(); }
      });
    }
    async function apiGET(q){ const params = Object.fromEntries(new URLSearchParams(q)); return jsonp(params); }
    async function apiPOST(body){ return jsonp(body); } // doGet æ”¯æ´ action=save
async function loadInit(){
      const d = await apiGET(`action=init&judge=${encodeURIComponent(JUDGE)}`);
      $('#title').textContent = JUDGE? `${JUDGE} è©•é¸å§”å“¡` : 'è©•åˆ†ç³»çµ±ï¼ˆæœªå¸¶å…¥è©•å¯©å§“åï¼‰';
      const sel = $('#project'); sel.innerHTML='';
      if(!d.projects?.length){ sel.innerHTML = '<option value="">ï¼ˆå°šç„¡éšŠä¼ï¼‰</option>'; return; }
      d.projects.forEach(p=>{ const opt=document.createElement('option'); opt.value=JSON.stringify(p); opt.textContent=buildProjectOptionText(p); sel.appendChild(opt); });
    }
function fillScores(map){
      if(!map) return;
      for(const id of IDS){
        const el = document.getElementById(id);
        const v = map[id] ?? 0;
        el.value = v;
      }
      liveTotal();
    }
async function loadLast(){
      const p = getSelectedProject(); if(!p) return toast('è«‹å…ˆé¸æ“‡åœ˜éšŠ', false);
      const data = await apiGET(`action=last&judge=${encodeURIComponent(JUDGE)}&projectId=${encodeURIComponent(p.id)}`);
      if(!data || !data.items){ toast('æ²’æœ‰ä¸Šä¸€ç­†è©•åˆ†'); resetScores(); return; }
      fillScores(data.items); $('#comment').value = data.comment || ''; toast('å·²è¼‰å…¥å‰ä¸€æ¬¡è©•åˆ†');
    }
function resetScores(){ els.forEach(el=>el.value=0); $('#comment').value=''; liveTotal(); }
    function getSelectedProject(){ const v=$('#project').value; if(!v) return null; return JSON.parse(v); }
async function save(){
  const p = getSelectedProject(); const btn=$('#btnSave');
  if(!p) return toast('è«‹å…ˆé¸æ“‡åœ˜éšŠ', false);
// æ”¶é›†åˆ†æ•¸
  const scores={};
  els.forEach(el=>{
    const n=Number(el.value||0);
    if(isNaN(n)||n<0||n>100) throw new Error('æ¯é …éœ€ç‚º 0~100');
    scores[el.id]=n;
  });
// çµ„è«‹æ±‚
  const body = {
    action:'save',
    data: JSON.stringify({
      judge:JUDGE,
      projectId:p.id,
      team:p.team,
      vendor:p.vendor||'',
      scores,
      comment:$('#comment').value.trim()
    })
  };
btn.disabled=true; btn.textContent='é€å‡ºä¸­â€¦';
  try{
    const res = await apiPOST(body);
    // 1) å…ˆçœ‹ ok
    if (!res || res.ok === false) {
      throw new Error(res?.error || 'å¾Œç«¯å›å‚³å¤±æ•—');
    }
    // 2) ç¢ºèª total ç‚ºæ•¸å­—
    const total = Number(res.total);
    if (!Number.isFinite(total)) {
      throw new Error('å¾Œç«¯æœªå›å‚³ç¸½åˆ†ï¼ˆtotalï¼‰ã€‚è«‹æª¢æŸ¥ GAS çš„ save_ æ˜¯å¦æœ‰ return { ok:true, total }ï¼Œä»¥åŠè¡¨é ­æ¬„åæ˜¯å¦å®Œå…¨ä¸€è‡´ã€‚');
    }
toast(`å·²é€å‡ºï¼Œç¸½åˆ† ${total.toFixed(2)}`);
    // ä¸‹æ‹‰é¡¯ç¤ºã€Œå·²è©•åˆ†ã€
    p.hasScore = true;
    $('#project').selectedOptions[0].textContent = buildProjectOptionText(p);
  }catch(e){
    toast(e.message || 'é€å‡ºå¤±æ•—', false);
    // æƒ³çœ‹æ›´å¤šé™¤éŒ¯ç´°ç¯€å¯é–‹å•Ÿï¼š
    // console.error('save error:', e);
  }finally{
    btn.disabled=false; btn.textContent='é€å‡ºè©•åˆ†';
  }
}
// ===== æˆ‘çš„è©•åˆ†ç¸½è¦½ï¼ˆå‰ç«¯æ¸²æŸ“ï¼‹äº‹ä»¶ï¼‰ =====
    function renderMyList(items){
      const box = document.getElementById('myList');
      const body = document.getElementById('myListBody');
      if(!items || !items.length){
        body.innerHTML = '<div class="muted">å°šç„¡è©•åˆ†ç´€éŒ„</div>';
        box.style.display = '';
        return;
      }
      const rows = items.map(it=>{
        const time = it.updatedAt ? new Date(it.updatedAt) : null;
        const timeStr = time ? time.toLocaleString('zh-TW') : '';
        return `
          <tr>
            <td>${it.projectId}</td>
            <td>${it.team||''}</td>
            <td style="text-align:right">${(it.total??'').toString()}</td>
            <td>${timeStr}</td>
            <td><button class="ghost" data-pid="${it.projectId}">æª¢è¦–</button></td>
          </tr>`;
      }).join('');
      body.innerHTML = `
        <div style="overflow:auto">
          <table style="width:100%; border-collapse:collapse">
            <thead>
              <tr>
                <th style="text-align:left; border-bottom:1px solid var(--border); padding:6px 4px">å ±åç·¨è™Ÿ</th>
                <th style="text-align:left; border-bottom:1px solid var(--border); padding:6px 4px">éšŠä¼åç¨±</th>
                <th style="text-align:right;border-bottom:1px solid var(--border); padding:6px 4px">ç¸½åˆ†</th>
                <th style="text-align:left; border-bottom:1px solid var(--border); padding:6px 4px">æœ€å¾Œæ›´æ–°</th>
                <th style="text-align:left; border-bottom:1px solid var(--border); padding:6px 4px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
      box.style.display = '';
body.querySelectorAll('button[data-pid]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-pid');
          const sel = document.getElementById('project');
          let found = null;
          [...sel.options].forEach(opt=>{
            if(!opt.value) return;
            const p = JSON.parse(opt.value);
            if (String(p.id) === String(pid)) found = opt;
          });
          if(found){
            sel.value = found.value;
            resetScores();
            loadLast().catch(()=>{});
            toast(`å·²åˆ‡æ›è‡³ ${pid}ï¼Œä¸¦è¼‰å…¥ä¸Šä¸€ç­†è©•åˆ†`);
            window.scrollTo({ top:0, behavior:'smooth' });
          }else{
            toast(`åå–®ä¸­æ‰¾ä¸åˆ°ç·¨è™Ÿ ${pid}ï¼ˆå¯èƒ½æœªåœ¨ã€Œæ¯”è³½éšŠä¼åˆ—è¡¨ã€ï¼‰`, false);
          }
        });
      });
    }
async function loadMyScores(){
      const res = await apiGET(`action=list&judge=${encodeURIComponent(JUDGE)}`);
      renderMyList(res.items || []);
    }
  // å–å…¨éƒ¨éšŠä¼æ•¸ï¼ˆç”¨ init çš„å›å‚³ï¼‰
  async function fetchAllProjectsCount(){
    const d = await apiGET(`action=init&judge=${encodeURIComponent(JUDGE)}`);
    return (d.projects || []).length;
  }
  
  // æ‰“é–‹æœ€çµ‚ç¢ºèªå½ˆçª—ã€è¼‰å…¥æ¸…å–®
  async function openFinalModal(){
    const modal = document.getElementById('finalModal');
    const tbody = document.getElementById('finalTbody');
    const hint  = document.getElementById('finalHint');
    const msg   = document.getElementById('finalMsg');
    const chk   = document.getElementById('finalCheck');
  
    msg.textContent = '';
    chk.checked = false;
    tbody.innerHTML = '<tr><td colspan="4" style="padding:12px">è®€å–ä¸­â€¦</td></tr>';
    modal.style.display = 'flex';
  
    const [listRes, totalCount] = await Promise.all([
      apiGET(`action=list&judge=${encodeURIComponent(JUDGE)}`),
      fetchAllProjectsCount()
    ]);
    const items = listRes.items || [];
  
    if (!items.length){
      tbody.innerHTML = '<tr><td colspan="4" style="padding:12px">å°šç„¡è©•åˆ†ç´€éŒ„</td></tr>';
    }else{
      tbody.innerHTML = items.map(it=>{
        const time = it.updatedAt ? new Date(it.updatedAt) : null;
        const timeStr = time ? time.toLocaleString('zh-TW') : '';
        const totalStr = (it.total!==undefined && it.total!==null) ? Number(it.total).toFixed(2) : '';
        return `<tr>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb">${it.projectId}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb">${it.team||''}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;text-align:right">${totalStr}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb">${timeStr}</td>
        </tr>`;
      }).join('');
    }
  
    hint.innerHTML = `å·²è©•éšŠä¼æ•¸ï¼š<b>${items.length}</b>ï¼å…¨éƒ¨éšŠä¼æ•¸ï¼š<b>${totalCount}</b>ã€‚${items.length<totalCount ? 'ï¼ˆå°šæœªè©•å®Œï¼Œä¸èƒ½é€å‡º20å®¶æˆç¸¾æœ€çµ‚ç¢ºèªï¼‰' : ''}`;
    document.getElementById('finalSubmit').disabled = (items.length < totalCount);
  }
  
  // é€å‡º20å®¶æˆç¸¾æœ€çµ‚ç¢ºèªï¼ˆå¾Œç«¯ action=confirmï¼‰
  async function submitFinalConfirm(){
    const chk = document.getElementById('finalCheck');
    const msg = document.getElementById('finalMsg');
    if(!chk.checked){
      msg.textContent = 'è«‹å…ˆå‹¾é¸ç¢ºèªè²æ˜ã€‚';
      msg.style.color = '#b91c1c';
      return;
    }
    msg.textContent = 'é€å‡ºä¸­â€¦';
    msg.style.color = '#6b7280';
  
    try{
      const res = await apiPOST({ action:'confirm', data: JSON.stringify({ judge: JUDGE }) });
      if (!res || res.ok === false) throw new Error(res?.error || 'å¾Œç«¯å›å‚³å¤±æ•—');
      msg.textContent = 'å·²å®Œæˆæœ€çµ‚ç¢ºèªï¼';
      msg.style.color = '#059669';
    }catch(e){
      msg.textContent = e.message || 'é€å‡ºå¤±æ•—';
      msg.style.color = '#b91c1c';
    }
  }
// äº‹ä»¶
    els.forEach(el=> el.addEventListener('input', liveTotal));
    $('#btnSave').addEventListener('click', ()=>{ save().catch(e=>toast(e.message||'é€å‡ºå¤±æ•—', false)); });
    $('#btnLast').addEventListener('click', ()=>{ loadLast().catch(e=>toast(e.message||'è®€å–å¤±æ•—', false)); });
    document.getElementById('btnList').addEventListener('click', ()=>{ loadMyScores().catch(()=>toast('è®€å–å¤±æ•—', false)); });
    // åˆ‡æ›åœ˜éšŠæ™‚æ¸…ç©º
    document.getElementById('project').addEventListener('change', ()=>{ resetScores(); toast('å·²åˆ‡æ›åœ˜éšŠï¼Œè«‹è¼¸å…¥æ–°åˆ†æ•¸'); });
    document.getElementById('btnFinal').addEventListener('click', ()=>{ openFinalModal().catch(()=>toast('è®€å–å¤±æ•—',false)); });
    document.getElementById('finalClose').addEventListener('click', ()=>{ document.getElementById('finalModal').style.display='none'; });
    document.getElementById('finalSubmit').addEventListener('click', ()=>{ submitFinalConfirm().catch(()=>{}); });
// å•Ÿå‹•
    liveTotal();
    loadInit().catch(e=> toast(e.message||'åˆå§‹åŒ–å¤±æ•—', false));
  </script>
</body>
</html>
